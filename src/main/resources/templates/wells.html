<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Well Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .table-input  { width: 100px; }
        .consumed-cell { background-color: #f0fff0; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-success">
    <div class="container-fluid">
        <span class="navbar-brand">
            <i class="bi bi-cup-straw"></i> Well Inventory - <span th:text="${bar.barName}"></span>
        </span>
        <span class="text-white">
            Session #<span th:text="${sessionId}"></span>
            | Shift: <span th:text="${session.shiftType}"></span>
        </span>
    </div>
</nav>

<div class="container-fluid mt-4">

    <div id="errorMsg" class="alert alert-danger" style="display:none;"></div>
    <div id="successMsg" class="alert alert-success" style="display:none;"></div>

    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-3-circle"></i> Stage 3: Well Inventory</h5>
        </div>
        <div class="card-body">

            <form id="wellForm" th:action="@{/sessions/wells/{id}/save(id=${sessionId})}" method="post">

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Well</th>
                                <th>Opening Stock</th>
                                <th>Received from Distribution</th>
                                <th>Closing Stock</th>
                                <th class="consumed-cell">Consumed</th>
                                <th>Selling Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="product : ${products}">
                                <tr th:each="wellName : ${wellNames}">
                                    <td>
                                        <strong th:text="${product.productName}"></strong><br>
                                        <small class="text-muted" th:text="${product.brand}"></small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${wellName}"></span>
                                    </td>

                                    <input type="hidden"
                                           th:name="'productId_' + ${product.productId} + '_' + ${wellName}"
                                           th:value="${product.productId}"/>
                                    <input type="hidden"
                                           th:name="'wellName_' + ${product.productId} + '_' + ${wellName}"
                                           th:value="${wellName}"/>

                                    <!-- Opening -->
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               class="form-control table-input opening"
                                               th:name="'opening_' + ${product.productId} + '_' + ${wellName}"
                                               value="0"/>
                                    </td>

                                    <!-- Received - pre-filled from distribution, editable per well -->
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               class="form-control table-input received"
                                               th:name="'received_' + ${product.productId} + '_' + ${wellName}"
                                               th:value="${distributionMap[product.productId] != null ? distributionMap[product.productId] : 0}"/>
                                    </td>

                                    <!-- Closing -->
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               class="form-control table-input closing"
                                               th:name="'closing_' + ${product.productId} + '_' + ${wellName}"
                                               value="0"/>
                                    </td>

                                    <!-- Consumed - auto calculated -->
                                    <td class="consumed-cell">
                                        <input type="number" step="0.01"
                                               class="form-control table-input consumed"
                                               th:name="'consumed_' + ${product.productId} + '_' + ${wellName}"
                                               value="0" readonly/>
                                    </td>

                                    <!-- Selling Price -->
                                    <td>
                                        <span th:text="${prices[product.productId] != null ? prices[product.productId].sellingPrice : 'N/A'}"></span>
                                    </td>
                                </tr>
                            </th:block>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <!-- BACK: /sessions/distribution/{sessionId} -->
                    <a th:href="@{/sessions/distribution/{id}(id=${sessionId})}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Distribution
                    </a>
                    <!-- SAVE & COMMIT -->
                    <button type="button" onclick="saveAndCommit()" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Save &amp; Commit Session
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const sessionId = [[${sessionId}]];
    const barId     = [[${barId}]];

    // Auto-calculate consumed for each row
    document.querySelectorAll("tbody tr").forEach(row => {
        const opening  = row.querySelector(".opening");
        const received = row.querySelector(".received");
        const closing  = row.querySelector(".closing");
        const consumed = row.querySelector(".consumed");

        if (opening && received && closing && consumed) {
            function calculate() {
                const o = parseFloat(opening.value)  || 0;
                const r = parseFloat(received.value) || 0;
                const c = parseFloat(closing.value)  || 0;
                const result = o + r - c;
                consumed.value = result >= 0 ? result.toFixed(2) : "0.00";
            }
            calculate();
            opening.addEventListener("input", calculate);
            received.addEventListener("input", calculate);
            closing.addEventListener("input", calculate);
        }
    });

    function saveAndCommit() {
        const form     = document.getElementById("wellForm");
        const formData = new FormData(form);
        const errorDiv   = document.getElementById("errorMsg");
        const successDiv = document.getElementById("successMsg");
        errorDiv.style.display   = "none";
        successDiv.style.display = "none";

        // Step 1: Save well inventory
        fetch(`/sessions/wells/${sessionId}/save`, {
            method: 'POST',
            body: new URLSearchParams(formData)
        })
        .then(response => {
            if (!response.ok) return response.text().then(t => { throw new Error(t); });
            return response;
        })
        // Step 2: Commit session
        .then(() => fetch(`/api/sessions/${sessionId}/commit`, { method: 'POST' }))
        .then(response => {
            if (!response.ok) return response.text().then(t => { throw new Error(t); });
            return response;
        })
        // Step 3: Redirect to sessions list
        .then(() => {
            successDiv.textContent = "Session committed successfully! Redirecting...";
            successDiv.style.display = "block";
            setTimeout(() => {
                window.location.href = `/sessions/${barId}`;
            }, 1500);
        })
        .catch(err => {
            errorDiv.textContent = "Error: " + err.message;
            errorDiv.style.display = "block";
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>